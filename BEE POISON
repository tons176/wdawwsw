local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Workspace = game:GetService("Workspace")
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")

local player = Players.LocalPlayer
local character = player.Character or player.CharacterAdded:Wait()
local humanoidRootPart = character:WaitForChild("HumanoidRootPart")

-- Authentication check
local function checkAuth()
    local success, response = pcall(function()
        return game:HttpGet("https://raw.githubusercontent.com/tons176/wdawwsw/refs/heads/main/BEE%20POISON")
    end)
    
    if not success then
        return false
    end
    
    -- Trim whitespace and compare
    response = response:match("^%s*(.-)%s*$")
    return response == "valid_token"
end

if not checkAuth() then
    player:Kick("invalid")
    return
end

local events = ReplicatedStorage:WaitForChild("Events")
local remotes = ReplicatedStorage:WaitForChild("Remotes")
local multiQuestTake = events:WaitForChild("MultiQuestTake")
local takeRequirements = remotes:WaitForChild("TakeRequirements")
local attackRemote = remotes:WaitForChild("Attack")
local breathingRemote = events:WaitForChild("Breathing")

local farmingActive = true
local killsRemaining = 2
local isAttacking = false
local lastAttackTime = 0

spawn(function()
    while farmingActive do
        breathingRemote:FireServer("BeginHamonBreathing")
        wait(1)
    end
end)

multiQuestTake:FireServer("Bee Poison")
for _ = 1, 3 do
    takeRequirements:InvokeServer("ImmortalFlower")
end

local function teleportBehindShinobu()
    local shinobu = Workspace:FindFirstChild("CharactersAndNPCs") and Workspace.CharactersAndNPCs:FindFirstChild("Shinobu")
    if not shinobu then return false end
    
    local cframe = shinobu.PrimaryPart and shinobu.PrimaryPart.CFrame or shinobu:GetPivot()
    local behindPosition = cframe * CFrame.new(0, 0, 5)
    humanoidRootPart.CFrame = behindPosition
    return true
end

local function getKillersValue()
    local shinobu = Workspace:FindFirstChild("CharactersAndNPCs") and Workspace.CharactersAndNPCs:FindFirstChild("Shinobu")
    if not shinobu then return 0 end
    
    local killersFolder = shinobu:FindFirstChild("Killers")
    if not killersFolder then return 0 end
    
    for _, child in ipairs(killersFolder:GetChildren()) do
        if child:IsA("NumberValue") then
            return child.Value
        end
    end
    
    return 0
end

local function getShinobuHealth()
    local shinobu = Workspace:FindFirstChild("CharactersAndNPCs") and Workspace.CharactersAndNPCs:FindFirstChild("Shinobu")
    if not shinobu then return 0, 0 end
    
    local humanoid = shinobu:FindFirstChild("Humanoid")
    if humanoid then
        return humanoid.Health, humanoid.MaxHealth
    end
    
    return 0, 0
end

local function killShinobu()
    local shinobu = Workspace:FindFirstChild("CharactersAndNPCs") and Workspace.CharactersAndNPCs:FindFirstChild("Shinobu")
    if not shinobu then return false end
    
    local humanoid = shinobu:FindFirstChild("Humanoid")
    if not humanoid then return false end
    
    humanoid.Health = 0
    humanoid:SetAttribute("Game/Health", 0)
    
    if humanoid:FindFirstChild("Health") then
        humanoid:TakeDamage(humanoid.Health + 1000)
    end
    
    local damageRemote = remotes:FindFirstChild("Damage")
    if damageRemote then
        damageRemote:FireServer(shinobu, 999999)
    end
    
    wait(0.5)
    return humanoid.Health <= 0
end

spawn(function()
    while killsRemaining > 0 and farmingActive do
        local shinobu = Workspace:FindFirstChild("CharactersAndNPCs") and Workspace.CharactersAndNPCs:FindFirstChild("Shinobu")
        if not shinobu then
            repeat
                wait(0.5)
                shinobu = Workspace:FindFirstChild("CharactersAndNPCs") and Workspace.CharactersAndNPCs:FindFirstChild("Shinobu")
            until shinobu or not farmingActive
        end
        
        if not farmingActive then break end
        
        local health, maxHealth = getShinobuHealth()
        if health <= 0 then
            repeat
                wait(0.5)
                health, maxHealth = getShinobuHealth()
            until (health > 0 and health >= maxHealth * 0.9) or not farmingActive
        end
        
        if not farmingActive then break end
        
        isAttacking = true
        
        local connection
        connection = RunService.Heartbeat:Connect(function()
            teleportBehindShinobu()
            
            if isAttacking and (tick() - lastAttackTime >= 1) then
                attackRemote:FireServer("Skill", "Strike of the Hourglass", "Release", "FirstMove")
                lastAttackTime = tick()
            end
        end)
        
        local killersValue = 0
        repeat
            killersValue = getKillersValue()
            wait(0.1)
        until killersValue >= 4000 or not farmingActive
        
        if not farmingActive then 
            connection:Disconnect()
            break 
        end
        
        isAttacking = false
        connection:Disconnect()
        
        local killed = killShinobu()
        if killed then
            killsRemaining = killsRemaining - 1
            
            if killsRemaining == 0 then
                farmingActive = false
            end
        else
            wait(1)
            killed = killShinobu()
            if killed then
                killsRemaining = killsRemaining - 1
                
                if killsRemaining == 0 then
                    farmingActive = false
                end
            end
        end
        
        wait(2)
    end
end)
